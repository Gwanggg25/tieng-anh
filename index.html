<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Mini Game Tá»« Vá»±ng</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;min-height:100vh;
  font-family:Arial,sans-serif;
  color:#fff;
  display:flex;justify-content:center;align-items:center;
  background:
    linear-gradient(rgba(0,0,0,.6),rgba(0,0,0,.6)),
    url("https://images.unsplash.com/photo-1500530855697-b586d89ba3ee");
  background-size:cover;
  background-position:center;
  transition:.3s;
}
body.correct{background:linear-gradient(rgba(0,120,0,.7),rgba(0,120,0,.7)),url("https://images.unsplash.com/photo-1500530855697-b586d89ba3ee")}
body.wrong{background:linear-gradient(rgba(150,0,0,.7),rgba(150,0,0,.7)),url("https://images.unsplash.com/photo-1500530855697-b586d89ba3ee")}
.hidden{display:none}
.box{max-width:420px;width:100%;background:rgba(30,30,30,.92);padding:20px;border-radius:16px}
button,input{width:100%;padding:14px;margin:6px 0;border:none;border-radius:14px;font-size:16px}
button{cursor:pointer}
.green{background:#4caf50;color:#fff}
.blue{background:#2196f3;color:#fff}
.gray{background:#555;color:#fff}
#letters span{display:inline-block;padding:18px;margin:6px;background:#333;border-radius:14px;font-weight:bold;font-size:20px;cursor:pointer}
#letters span.used{opacity:.3}
.progress{height:8px;background:#333;border-radius:6px;overflow:hidden}
.progress div{height:100%;width:0%;background:#4caf50}
#correctText{color:#ffeb3b;font-weight:bold}
</style>
</head>

<body>

<audio id="tapSound" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
<audio id="correctSound" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
<audio id="wrongSound" src="https://assets.mixkit.co/active_storage/sfx/950/950-preview.mp3"></audio>
<audio id="bgMusic" loop src="https://assets.mixkit.co/music/preview/mixkit-dreaming-big-31.mp3"></audio>

<div id="login" class="box">
  <h2>ğŸ‘¤ Nháº­p tÃªn</h2>
  <input id="playerName" placeholder="TÃªn cá»§a báº¡n">
  <button class="green" onclick="enterGame()">VÃ o game</button>
</div>

<div id="home" class="box hidden">
  <h2>ğŸ® Mini Game</h2>
  <p>ğŸ‘¤ <b id="showName"></b></p>
  <button class="green" onclick="showLevel()">Xáº¿p chá»¯</button>
  <button class="green" onclick="startConnect()">Ná»‘i tá»«</button>
  <button class="blue" onclick="showRank()">ğŸ† Xáº¿p háº¡ng</button>
</div>

<div id="level" class="box hidden">
  <h3>ğŸ§  Chá»n má»©c Ä‘á»™</h3>
  <button class="green" onclick="startShuffle('easy')">Dá»…</button>
  <button class="green" onclick="startShuffle('medium')">Trung bÃ¬nh</button>
  <button class="green" onclick="startShuffle('hard')">KhÃ³</button>
  <button class="gray" onclick="backHome()">Quay láº¡i</button>
</div>

<div id="game" class="box hidden">
  <h3 id="title"></h3>
  <div class="progress"><div id="bar"></div></div>
  <p>â­ <span id="score">0</span> | ğŸ”¥ Combo: <span id="combo">0</span></p>
  <div id="letters"></div>
  <p>ÄÃ¡p Ã¡n: <b id="answer"></b></p>
  <p id="correctText"></p>
  <button class="blue" onclick="check()">Kiá»ƒm tra</button>
  <button class="gray" onclick="clearAnswer()">XoÃ¡</button>
  <button class="gray" onclick="backHome()">Quay láº¡i</button>
</div>

<div id="rank" class="box hidden">
  <h3>ğŸ† TOP 48</h3>
  <ol id="rankList"></ol>
  <button class="gray" onclick="backHome()">Quay láº¡i</button>
</div>

<script>
/* ===== FIREBASE CONFIG â€“ ÄÃƒ Gáº®N CHO M ===== */
const firebaseConfig = {
  apiKey: "AIzaSyAu8h1mjEJkURRI7agXiziySfqQEwGGwt8",
  authDomain: "tieng-anh-d4c26.firebaseapp.com",
  databaseURL: "https://tieng-anh-d4c26-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tieng-anh-d4c26",
  storageBucket: "tieng-anh-d4c26.firebasestorage.app",
  messagingSenderId: "252485206184",
  appId: "1:252485206184:web:841c6067144c981bcc829d",
  measurementId: "G-KBCXERQMSM"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const shuffleEasy=["TOURISM","SOLUTION","REMOVE","LITTER","ADVICE"];
const shuffleMedium=["REQUIRE","ESCAPE","HARSH","CHALLENGE"];
const shuffleHard=["TEMPERATURE","FRIGHTENED","COMPETITION"];
const connectWords=["GLOBAL WARMING","SEA LEVEL","CLIMATE CHANGE","PROUD OF"];

let pool=[],correct="",answer="";
let score=0,combo=0,done=0;
let mode="",player="",uid="";
const $=id=>document.getElementById(id);

function unlockAudio(){
  ["tapSound","correctSound","wrongSound","bgMusic"].forEach(id=>{
    $(id).play().then(()=>$(id).pause()).catch(()=>{});
  });
}

function enterGame(){
  unlockAudio();
  $("bgMusic").play();
  player=$("playerName").value||"Player";
  uid=Date.now()+"_"+Math.floor(Math.random()*9999);
  $("showName").innerText=player;
  hideAll();$("home").classList.remove("hidden");
}

function showLevel(){hideAll();$("level").classList.remove("hidden")}
function startShuffle(lv){
  mode="shuffle";
  pool=[...(lv==="easy"?shuffleEasy:lv==="medium"?shuffleMedium:shuffleHard)].sort(()=>Math.random()-0.5);
  startGame("Xáº¿p chá»¯");
}
function startConnect(){
  mode="connect";
  pool=[...connectWords].sort(()=>Math.random()-0.5);
  startGame("Ná»‘i tá»«");
}

function startGame(title){
  document.body.className="";
  $("correctText").innerText="";
  if(pool.length===0) return backHome();
  correct=pool.pop();
  answer="";
  $("letters").innerHTML="";
  $("answer").innerText="";
  $("title").innerText=title;

  const parts=mode==="shuffle"?correct.split(""):correct.split(" ");
  parts.sort(()=>Math.random()-0.5).forEach(c=>{
    const s=document.createElement("span");
    s.innerText=c;
    s.onclick=()=>{
      if(s.classList.contains("used"))return;
      $("tapSound").play();
      s.classList.add("used");
      answer+=(mode==="shuffle"?c:(answer?" ":"")+c);
      $("answer").innerText=answer;
    };
    $("letters").appendChild(s);
  });

  hideAll();$("game").classList.remove("hidden");
}

function check(){
  document.body.className="";
  if(answer.trim()===correct){
    combo++;score+=10*combo;done++;
    $("correctSound").play();
    document.body.classList.add("correct");
  }else{
    combo=0;
    $("wrongSound").play();
    $("correctText").innerText="âŒ "+correct;
    document.body.classList.add("wrong");
  }
  update();
  setTimeout(()=>startGame($("title").innerText),700);
}

function update(){
  $("score").innerText=score;
  $("combo").innerText=combo;
  $("bar").style.width=Math.min(100,done*5)+"%";
}

function clearAnswer(){
  answer="";
  $("answer").innerText="";
  [...$("letters").children].forEach(s=>s.classList.remove("used"));
}

function hideAll(){["login","home","level","game","rank"].forEach(id=>$(id).classList.add("hidden"))}
function backHome(){
  saveScore();
  hideAll();$("home").classList.remove("hidden");
}

/* ===== RANK REALTIME ===== */
function saveScore(){
  if(!player) return;
  db.ref("rank/"+uid).set({
    name: player,
    score: score,
    time: Date.now()
  });
}

function showRank(){
  hideAll();$("rank").classList.remove("hidden");
  db.ref("rank")
    .orderByChild("score")
    .limitToLast(48)
    .on("value",snap=>{
      const list=$("rankList");
      list.innerHTML="";
      const data=[];
      snap.forEach(s=>data.push(s.val()));
      data.sort((a,b)=>b.score-a.score);
      data.forEach(d=>{
        const li=document.createElement("li");
        li.innerText=`${d.name} â€” ${d.score}Ä‘`;
        list.appendChild(li);
      });
    });
}
</script>
</body>
    </html>
